{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SynergySphere - Project Detail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-900 dark:text-white min-h-screen flex transition-colors duration-500">

  <aside id="sidebar" class="w-64 bg-white dark:bg-neutral-900 shadow-xl border-r border-gray-200 dark:border-gray-800 flex flex-col justify-between p-4 transition-all duration-500 ease-in-out">
  <div>
    <button id="toggleBtn" class="flex items-center gap-3 mb-6 px-3 py-2 rounded-lg bg-gray-100 dark:bg-neutral-800 hover:bg-gray-200 dark:hover:bg-neutral-700 hover:scale-105 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
      <span class="font-medium nav-text">Collapse</span>
    </button>

    <h1 id="brandTitle" class="text-2xl font-bold mb-8 text-gray-800 dark:text-white tracking-tight bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
      SynergySphere
    </h1>

    <nav class="space-y-4">
      <a href="{% url 'dashboard' %}" class="flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-blue-100 dark:hover:bg-blue-900 hover:scale-105 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"/>
        </svg>
        <span class="font-medium nav-text">Projects</span>
      </a>
      <a href="{% url 'taskview' %}" class="flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-green-100 dark:hover:bg-green-900 hover:scale-105 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span class="font-medium nav-text">My Tasks</span>
      </a>
    </nav>
  </div>

  <div class="space-y-4">
    <button id="themeToggle" class="flex items-center gap-3 px-4 py-2 rounded-xl bg-gray-200 dark:bg-neutral-700 text-gray-800 dark:text-gray-200 hover:bg-purple-100 dark:hover:bg-purple-900 hover:scale-105 transition">
      <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 0111.21 3a7 7 0 000 14A9 9 0 0121 12.79z" />
      </svg>
      <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 hidden dark:inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364 6.364l-1.414-1.414M7.05 7.05L5.636 5.636m12.728 0l-1.414 1.414M7.05 16.95l-1.414 1.414" />
      </svg>
      <span class="text-sm nav-text">Toggle Theme</span>
    </button>

    <a href="{% url 'profile' %}" class="flex items-center gap-3 p-3 bg-gray-100 dark:bg-neutral-800 rounded-xl shadow hover:bg-pink-100 dark:hover:bg-pink-900 hover:scale-105 transition">
      <img src="{% if request.user.is_authenticated and request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'images/avatar.png' %}{% endif %}" 
           alt="user" 
           class="w-10 h-10 rounded-full border border-gray-300 dark:border-gray-700">
      <div class="nav-text">
        <p class="font-semibold">
          {% if request.user.is_authenticated %}
            {{ request.user.username }}
          {% else %}
            Guest
          {% endif %}
        </p>
        <p class="text-gray-500 dark:text-gray-400 text-sm truncate">
          {% if request.user.is_authenticated %}
            {{ request.user.email }}
          {% else %}
            guest@example.com
          {% endif %}
        </p>
      </div>
    </a>
  </div>
</aside>


  <main class="flex-1 p-8">
    <div class="flex justify-between items-center mb-10">
      <p class="text-sm text-gray-500 dark:text-gray-400">
        Projects > <span class="font-medium text-gray-900 dark:text-white">{{ project.name }}</span>
      </p>
      <div class="flex items-center gap-4">
        <input type="text" placeholder="Search..."
          class="px-4 py-2 rounded-xl bg-gray-200 dark:bg-neutral-800 text-black dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">

        <button onclick="openModal()" 
          class="px-5 py-2 bg-purple-500 text-white font-medium rounded-xl hover:bg-purple-600 hover:scale-105 shadow-md transition">
          + Add People
        </button>

        <a href="{% url 'new_task' project.id %}" 
          class="px-5 py-2 bg-blue-500 text-white font-medium rounded-xl hover:bg-blue-600 hover:scale-105 shadow-md transition">
          + New Task
        </a>
      </div>
    </div>

    <div id="taskContainer" class="grid grid-cols-1 md:grid-cols-3 gap-8">
      {% for task in tasks %}
        <div class="p-5 rounded-xl shadow-md bg-white dark:bg-neutral-900 border border-gray-200 dark:border-gray-700 fade-in">
          <h3 class="font-semibold text-lg">{{ task.name }}</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">{{ task.description|default:"No description" }}</p>
          <p class="text-xs text-gray-400">Assignee: <span class="font-medium text-gray-800 dark:text-white">{{ task.assignee }}</span></p>
          <p class="text-xs text-gray-400">Status: <span class="font-medium text-blue-500">{{ task.status }}</span></p>
          <p class="text-xs text-gray-400">Deadline: {{ task.deadline|date:"M d, Y" }}</p>
        </div>
      {% empty %}
        <p class="text-gray-400">No tasks found. Click <b>+ New Task</b> to add one.</p>
      {% endfor %}
    </div>
  </main>

  <div id="addPeopleModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white dark:bg-neutral-900 p-6 rounded-2xl shadow-lg w-full max-w-md relative">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">✕</button>
      
      <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
        Add People to {{ project.name }}
      </h2>

      <input type="text" id="userSearch" placeholder="Search by name or email..."
        class="w-full mb-4 px-4 py-2 rounded-xl bg-gray-100 dark:bg-neutral-800 text-black dark:text-white focus:ring-2 focus:ring-purple-500 outline-none">

      <ul id="searchResults" class="space-y-2 max-h-60 overflow-y-auto"></ul>
    </div>
  </div>

  <script>
    const toggleBtn = document.getElementById("toggleBtn");
    const sidebar = document.getElementById("sidebar");
    const themeToggle = document.getElementById("themeToggle");
    const html = document.documentElement;

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("w-64");
      sidebar.classList.toggle("w-20");
      document.querySelectorAll(".nav-text, #brandTitle").forEach(el => {
        el.classList.toggle("hidden");
      });
    });

    themeToggle.addEventListener("click", () => {
      html.classList.toggle("dark");
      localStorage.setItem("theme", html.classList.contains("dark") ? "dark" : "light");
    });

    if (localStorage.getItem("theme") === "dark") {
      html.classList.add("dark");
    }

    function openModal() {
      document.getElementById("addPeopleModal").classList.remove("hidden");
      document.getElementById("addPeopleModal").classList.add("flex");
    }
    function closeModal() {
      document.getElementById("addPeopleModal").classList.add("hidden");
      document.getElementById("addPeopleModal").classList.remove("flex");
    }

    const searchInput = document.getElementById("userSearch");
    const resultsBox = document.getElementById("searchResults");

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    searchInput.addEventListener("keyup", () => {
      const query = searchInput.value.trim();
      if (query.length < 2) {
        resultsBox.innerHTML = "";
        return;
      }

      fetch(`/search-users/?q=${query}`)
        .then(res => res.json())
        .then(data => {
          resultsBox.innerHTML = "";
          if (data.length === 0) {
            resultsBox.innerHTML = `<p class="text-gray-400 text-sm">No users found.</p>`;
          }
          data.forEach(user => {
            const li = document.createElement("li");
            li.innerHTML = `
              <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-neutral-800 rounded-lg">
                <div>
                  <p class="font-medium text-gray-800 dark:text-white">${user.username}</p>
                  <p class="text-xs text-gray-500">${user.email}</p>
                </div>
                <button onclick="addUser('${user.email}')" 
                  class="px-3 py-1 bg-purple-500 text-white text-xs rounded-lg hover:bg-purple-600">
                  Add
                </button>
              </div>
            `;
            resultsBox.appendChild(li);
          });
        });
    });

    function addUser(email) {
      fetch(`/project/{{ project.id }}/add-people/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrftoken
        },
        body: new URLSearchParams({ email: email })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`${email} added to project ✅`);
        } else {
          alert(data.error || "Failed to add user ❌");
        }
      });
    }
  </script>

</body>
</html>
